<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Отчет 2</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<!-- <link rel="stylesheet" href="style.css"> -->
	<!-- <link rel="stylesheet" href="jquery-ui.min.css"> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js"></script>
</head>
<body id="demo">

	<h3>Сводный отчет по всем мастерам за апрель <span id="curDate"></span></h3>
    <!-- <input v-model="date1" debounce="500" class="form-control" value="2016-01-15" id="d1"> -->
    <!-- <input v-model="date2" debounce="500" class="form-control" value="2016-01-26" id="d2"> -->

<table class="table table-striped table-condensed table-hover table-bordered">
	<thead>
		<tr class="info">
			<th class="col-xs-1"><a href="#">Дата</a></th>
			<th class="col-xs-3" v-for="master in masters | orderBy 'master'"><a href="#">{{master}}</a></th>
		</tr>
	</thead>
	<tbody>
		<tr v-for="item in m">
			<td>{{item.Дата | fixDate1}}</td>
			<td v-for="master in masters | orderBy 'master'">
				<table class="table table-striped table-condensed table-hover table-bordered">
					<thead>
						<tr class="info">
							<th><a href="#">Заявка</a></th>
							<th><a href="#">Статус</a></th>
							<th><a href="#">Сумма</a></th>							
						</tr>
					</thead>
					<tbody>
						<tr v-for="zayavka in item | disp master">
							<td>{{ zayavka.Заявка }}</td>
							<td>{{ zayavka.Статус }}</td>
							<td>{{ zayavka.Сумма }}</td>				
						</tr>
					</tbody>
				</table>
			</td>	
		</tr>
	</tbody>
</table>

<script src="moment-with-locales.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.20/vue.js"></script>
<script>
var vm = new Vue ({
	el: "#demo",
	data : {
		j1 : (function () {
	    	var dataJson = null;
	    	$.ajax({
	        'async': false,
	        'global': false,
	        'url': '1.json',
	        'dataType': "json",
	        'success': function (json) {
	    	    dataJson = json;
	    	    // console.log(json);
    		}
	    	});
	        return dataJson;        
		})(),

		j2 : (function () {
	    	var dataJson = null;
	    	$.ajax({
	        'async': false,
	        'global': false,
	        'url': '2.json',
	        'dataType': "json",
	        'success': function (json) {
	    	    dataJson = json;
	    	    // console.log(json);
    		}
	    	});
	        return dataJson;
		})(),

		j3 : (function () {
	    	var dataJson = null;
	    	$.ajax({
	        'async': false,
	        'global': false,
	        'url': '3.json',
	        'dataType': "json",
	        'success': function (json) {
	    	    dataJson = json;
	    	    // console.log(json);
    		}
	    	});	    	
	        return dataJson;
		})(),

		masters : [], // список мастеров

		m : [], // основной массив

		iDate : "" 
				
		},

	filters	: {
		disp : function(obj, master) { return obj[master] },
		fixDate1: function(date) { return moment(date).locale('ru').format("DD-MMM-YYYY ddd") }
	},


	methods : { 
		initArrays : function(date1,date2) {

			var Line = {};
			Line.Дата = '';

			// считываем список мастеров из хэш-таблицы j3 (справочник)		
			for (var i = 0, l = this.j3.length; i < l; i++) {
					this.masters.push(this.j3[i].Мастер);
					Line[this.j3[i].Мастер] = '';
				};		
			
			console.log(Line);
			// находим самую раннюю дату в таблице j1
			// var iDate = moment("25 01 2016", "DD MM YYYY").locale('ru').format("DD-MMM-YYYY");

			var startDate = date1;
			var endDate = date2;

			var startDate = moment("2016-04-01").locale('ru').format("YYYY-MM-DD");			
			var endDate = moment("2016-04-11").locale('ru').format("YYYY-MM-DD");

			// console.log(moment(startDate).add(1, 'days').locale('ru').format("YYYY-MM-DD"));

			// var iDate = startDate;

			for (var iDate = startDate; iDate < endDate; iDate = moment(iDate).add(1, 'days').locale('ru').format("YYYY-MM-DD") ){
				// console.log("iDate: " + iDate, "endDate: " + endDate);
				// $('#curDate').html('sddfdf');
				newLine = Object.create(Line);
				// console.log(newLine);				
				newLine.Дата = iDate;

				for (var i = 0; i < this.masters.length; i++) {
					var sum = 0;
					var mm = [];
					var MiniLine = {}; // прототип маленькой строки (Заявка + Статус + Сумма)
					// цикл по всей j1 в поисках такой же даты и такого же мастера
					for (var j = 800; j < this.j1.length; j++) {
						newMiniLine = Object.create(MiniLine); // новый экземпляр строки таблицы по образу объекта MiniLine
						jDate = this.j1[j].Дата;
						// console.log(jDate);
						jDate = moment(jDate).locale('ru').format("YYYY-MM-DD");		
						jMaster = this.j1[j].Мастер;
						iMaster = this.masters[i];
						jSum = this.j1[j].Сумма;

						if (jDate === iDate && jMaster === iMaster) {
							sum += Number(jSum)
							newMiniLine.Заявка = this.j1[j].Заявка;
							newMiniLine.Статус = this.j1[j].Статус;
							newMiniLine.Сумма = this.j1[j].Сумма;
						}

						newLine[iMaster] = sum;
						if (newMiniLine.Заявка) {mm.push(newMiniLine)};
					}

					newLine[this.masters[i]] = mm;

					console.log(newLine);
					// console.log("iDate: " + iDate, iMaster, "jDate: " + jDate, jMaster);
				}
				this.m.push(newLine);
				// console.log(this.m);				
			}

			// тут явно нужен какой-то констуктор класса объекта

				// начинаем цикл по датам с этой даты до сегодня

					// формируем комплексный объект-строку большой таблицы (здесь предположение по поводу использования конструктора прототипа объекта)

					// внутри этого объекта формируем массив вложенных объектов-строк малой таблицы

				// переходим к следующей дате

			// this.m = []
		}
	}
	
})

vm.initArrays();

Vue.config.devtools = true;
Vue.config.debug = true;

</script>
</body>
</html>